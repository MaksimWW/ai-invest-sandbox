# â”€â”€â”€â”€ ĞŸĞ£ĞĞšĞ¢ 1: sentiment Ñ‡ĞµÑ€ĞµĞ· OpenAI + fetch_ru_news â”€â”€â”€â”€
set -e

### 1. Ğ Ğ°ÑÑˆĞ¸Ñ€ÑĞµĞ¼ nlp/sentiment.py
grep -q "def rss_sentiment_summary" nlp/sentiment.py || cat >> nlp/sentiment.py <<'PY'

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  RSS-Sentiment summary (OpenAI)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import os, json, openai
from collections import Counter
from typing import Dict

def rss_sentiment_summary(hours: int = 24) -> Dict[str, int]:
    """
    Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ {'positive': N, 'neutral': M, 'negative': K} Ğ´Ğ»Ñ Ñ€ÑƒÑÑĞºĞ¸Ñ… RSS-Ğ½Ğ¾Ğ²Ğ¾ÑÑ‚ĞµĞ¹
    Ğ·Ğ° *hours* Ñ‡Ğ°ÑĞ¾Ğ².  ĞœĞ¾Ğ¶ĞµÑ‚ Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹ dict, ĞµÑĞ»Ğ¸ Ğ½Ğ¾Ğ²Ğ¾ÑÑ‚ĞµĞ¹ Ğ½ĞµÑ‚.
    Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾Ğ¹ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ OPENAI_API_KEY.
    """
    headlines = fetch_ru_news(hours)
    if not headlines:
        return {}

    openai.api_key = os.getenv("OPENAI_API_KEY")
    if not openai.api_key:
        raise RuntimeError("OPENAI_API_KEY Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½")

    prompt = (
        "ĞšĞ»Ğ°ÑÑĞ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€ÑƒĞ¹ Ñ‚Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¾Ğ² (positive / neutral / negative) "
        "Ğ¸ Ğ²Ñ‹Ğ²ĞµĞ´Ğ¸ JSON Ğ²Ğ¸Ğ´Ğ° {\"positive\":N,\"neutral\":M,\"negative\":K}.\n\n"
        + "\n".join(f"- {h}" for h in headlines[:25])  # â‰¤25 ÑÑ‚Ñ€Ğ¾Ğº, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑƒĞ»Ğ¾Ğ¶Ğ¸Ñ‚ÑŒÑÑ Ğ² Ñ‚Ğ¾ĞºĞµĞ½Ñ‹
    )

    chat = openai.ChatCompletion.create(
        model="gpt-3.5-turbo",
        messages=[{"role": "user", "content": prompt}],
        max_tokens=50,
        temperature=0,
    )
    try:
        counts = json.loads(chat.choices[0].message.content.strip())
        # Ğ¿Ñ€Ğ¸Ğ²Ğ¾Ğ´Ğ¸Ğ¼ Ğº int Ğ¸ Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ ĞºĞ»ÑÑ‡Ğ¸ Ğ½ÑƒĞ»ÑĞ¼Ğ¸
        total = Counter({k: int(counts.get(k, 0)) for k in ("positive", "neutral", "negative")})
        return dict(total)
    except Exception:
        return {}
PY

### 2. ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ /sentiment-ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ Ğ² Ğ±Ğ¾Ñ‚Ğµ (PTB v20)
sed -i '
/def cmd_sentiment(/,/^$/c\
def cmd_sentiment(update: Update, context: ContextTypes.DEFAULT_TYPE):\
    \"\"\"/sentiment â€” ÑĞ²Ğ¾Ğ´ĞºĞ° Ñ‚Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸ Ñ€ÑƒÑÑĞºĞ¸Ñ… Ğ½Ğ¾Ğ²Ğ¾ÑÑ‚ĞµĞ¹\"\"\"\
    from nlp.sentiment import rss_sentiment_summary\
    try:\
        counts = rss_sentiment_summary(24)\
        if not counts:\
            update.message.reply_text(\"âš ï¸ ĞĞµÑ‚ ÑĞ²ĞµĞ¶Ğ¸Ñ… Ğ½Ğ¾Ğ²Ğ¾ÑÑ‚ĞµĞ¹ Ğ¸Ğ»Ğ¸ OpenAI Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½\")\
            return\
        msg = \"ğŸ“Š Ğ¢Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ·Ğ° 24 Ñ‡:\\n\" + \"\\n\".join(f\"{k}: {v}\" for k, v in counts.items())\
        update.message.reply_text(msg)\
    except Exception as e:\
        update.message.reply_text(f\"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° sentiment: {e}\")' \
daily_plan_bot_ptb.py

### 3. ĞœĞ¸Ğ½Ğ¸-Ñ‚ĞµÑÑ‚ (Ğ½Ğµ Ğ¾Ğ±Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ÑÑ Ğº OpenAI, Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğº fetch_ru_news)
mkdir -p tests
cat > tests/test_sentiment_basic.py <<'PY'
from nlp.sentiment import fetch_ru_news
def test_fetch_ru_nonerror():
    """fetch_ru_news Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ²ÑĞµĞ³Ğ´Ğ° Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°Ñ‚ÑŒ list (Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹)."""
    headlines = fetch_ru_news(1)
    assert isinstance(headlines, list)
PY

### 4. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼
pytest -q -rs